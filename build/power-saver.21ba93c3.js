let e,t,n,a,o,r,c,s,i,l,d,u,m,g,p,h,y,A,v,w;const E="powerMeterSession";function f(e){try{let t={timestamp:Date.now(),powerData:e.powerData,lastPowerValue:e.lastPowerValue,lastHeartRateValue:e.lastHeartRateValue,lastCadenceValue:e.lastCadenceValue,sessionStartTime:e.sessionStartTime};localStorage.setItem(E,JSON.stringify(t))}catch(e){console.warn("Failed to save session data:",e)}}function C(){localStorage.removeItem(E)}const S={"10s":1e4,"20s":2e4,"30s":3e4,"40s":4e4,"50s":5e4,"1m":6e4,"2m":12e4,"3m":18e4,"4m":24e4,"5m":3e5};let I=[];const x=[],b=[];let B={"10s":{current:0,best:0},"20s":{current:0,best:0},"30s":{current:0,best:0},"40s":{current:0,best:0},"50s":{current:0,best:0},"1m":{current:0,best:0},"2m":{current:0,best:0},"3m":{current:0,best:0},"4m":{current:0,best:0},"5m":{current:0,best:0}};function D(){if(e)try{e.textContent=B["10s"].current||"--",t.textContent=B["10s"].best||"--",n.textContent=B["20s"].current||"--",a.textContent=B["20s"].best||"--",o.textContent=B["30s"].current||"--",r.textContent=B["30s"].best||"--",c.textContent=B["40s"].current||"--",s.textContent=B["40s"].best||"--",i.textContent=B["50s"].current||"--",l.textContent=B["50s"].best||"--",d.textContent=B["1m"].current||"--",u.textContent=B["1m"].best||"--",m.textContent=B["2m"].current||"--",g.textContent=B["2m"].best||"--",p.textContent=B["3m"].current||"--",h.textContent=B["3m"].best||"--",y.textContent=B["4m"].current||"--",A.textContent=B["4m"].best||"--",v.textContent=B["5m"].current||"--",w.textContent=B["5m"].best||"--"}catch(e){console.error("Error updating power averages display:",e.message)}}function M(){for(let e of(I=[],Object.keys(B)))B[e].current=0,B[e].best=0;D()}const k={powerValueElement:null,hrValueElement:null,cadenceValueElement:null,deviceNameElement:null,hrDeviceName:null,cadenceDeviceName:null,statusText:null,hrStatusText:null,cadenceStatusText:null,hrConnectionStatus:null,cadenceConnectionStatus:null,powerMeterConnectButton:null,hrConnectButton:null,speedCadenceConnectButton:null,exportButtons:{json:null,csv:null,tcx:null,image:null,clearSession:null},powerAveragesSection:null,hamburgerBtn:null,menuDropdown:null,powerAveragesToggle:null,powerMetricToggle:null,heartRateMetricToggle:null,cadenceMetricToggle:null,showInfoMenuItem:null,spyModeToggle:null,powerCard:null,heartRateCard:null,cadenceCard:null,spyCard:null,spyModeSection:null,spyValueElement:null,spyStatusElement:null,spyInstructionsElement:null};function L(e){if(!k.powerValueElement)return;let t=e||"--";k.powerValueElement.textContent=t,k.powerValueElement.setAttribute("data-value",t)}function T(){L("--"),k.hrValueElement&&(k.hrValueElement.textContent="--"),k.cadenceValueElement&&(k.cadenceValueElement.textContent="--")}function Q(){let e=new Date,t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${t}-${n}-${a}`}async function N(){if(!("wakeLock"in navigator))return console.warn("Wake Lock API is not supported in this browser"),!1;try{return(await navigator.wakeLock.request("screen")).addEventListener("release",()=>{console.log("Screen wake lock was released")}),console.log("Screen wake lock acquired"),!0}catch(e){return console.error("Failed to acquire wake lock:",e.name,e.message),!1}}const V="cycling_power",U="cycling_power_measurement",R="cycling_speed_and_cadence";let Y=null,P=null,F=null,J=null,O=null,H=null,W=null,q=null,j=null,z=0,Z=0,G=null;async function K(e,t){if(await N(),!navigator.bluetooth)return e.onStatusUpdate("Web Bluetooth API is not available."),!1;try{if(e.onStatusUpdate("Scanning for power meters..."),Y&&(O&&(Y.removeEventListener("gattserverdisconnected",O),O=null),Y.gatt.connected&&Y.gatt.disconnect(),Y=null),!(Y=await navigator.bluetooth.requestDevice({filters:[{services:[V]}]})))throw Error("No device selected");e.onStatusUpdate("Connecting to device..."),t.deviceNameElement&&(t.deviceNameElement.textContent=`Device: ${Y.name||"Unknown Device"}`),O=()=>{var n,a;n=e,a=t,n.onStatusUpdate("Power meter disconnected."),a.deviceNameElement&&(a.deviceNameElement.textContent=""),Y&&O&&(Y.removeEventListener("gattserverdisconnected",O),O=null),Y=null,n.onDisconnected()},Y.addEventListener("gattserverdisconnected",O);let n=await Y.gatt.connect(),a=await n.getPrimaryService(V),o=await a.getCharacteristic(U);try{let e=await a.getCharacteristic("cycling_power_feature");await e.readValue()}catch{}return await o.startNotifications(),o.addEventListener("characteristicvaluechanged",t=>{!function(e,t){try{let n=e.target.value;if(!n||!(n instanceof DataView))return void console.error("Invalid power measurement data: value must be a DataView");if(n.byteLength<4)return void console.error(`Invalid power measurement data: insufficient data (${n.byteLength} bytes)`);let a=n.getInt16(2,!0);if(isNaN(a))return void console.error("Invalid power value: NaN");a>3e3?console.warn(`Unusually high power detected: ${a}W`):a<-500&&console.warn(`Unusually low power detected: ${a}W`),t.onPowerMeasurement(a)}catch(e){console.error("Error parsing power measurement data:",e.message)}}(t,e)}),e.onStatusUpdate("Connected and receiving data!"),!0}catch(t){return"NotFoundError"===t.name?e.onStatusUpdate("No device selected."):(e.onStatusUpdate(`Error: ${t.message}`),console.error("Power meter connection failed:",t)),Y&&(O&&(Y.removeEventListener("gattserverdisconnected",O),O=null),Y=null),!1}}async function X(e,t){if(await N(),!navigator.bluetooth)return e.onStatusUpdate("Web Bluetooth API is not available."),!1;try{if(e.onStatusUpdate("Scanning for devices..."),t.hrConnectionStatus&&(t.hrConnectionStatus.textContent="Connecting..."),P){if(q&&j){try{q.removeEventListener("characteristicvaluechanged",j)}catch(e){console.warn("Error removing HR characteristic listener:",e)}j=null,q=null}H&&(P.removeEventListener("gattserverdisconnected",H),H=null),P.gatt.connected&&P.gatt.disconnect(),P=null}if(!(P=await navigator.bluetooth.requestDevice({filters:[{services:["heart_rate"]}],optionalServices:["device_information","battery_service"]})))throw Error("No device selected");return await $(P,e,t),!0}catch(n){if("NotFoundError"===n.name?(e.onStatusUpdate("No device selected."),t.hrConnectionStatus&&(t.hrConnectionStatus.textContent="Disconnected")):(e.onStatusUpdate(`Error: ${n.message}`),t.hrConnectionStatus&&(t.hrConnectionStatus.textContent="Connection Failed"),console.error("Heart rate monitor connection failed:",n)),q&&j){try{q.removeEventListener("characteristicvaluechanged",j)}catch(e){}j=null,q=null}return P&&H&&(P.removeEventListener("gattserverdisconnected",H),H=null),P=null,!1}}async function $(e,t,n){t.onStatusUpdate("Connecting to device..."),H=()=>{var e=t,a=n;if(e.onStatusUpdate("Heart rate monitor disconnected."),a.hrConnectionStatus&&(a.hrConnectionStatus.textContent="Disconnected"),a.hrDeviceName&&(a.hrDeviceName.textContent=""),q&&j){try{q.removeEventListener("characteristicvaluechanged",j)}catch(e){console.warn("Error removing HR characteristic listener on disconnect:",e)}j=null,q=null}P&&H&&(P.removeEventListener("gattserverdisconnected",H),H=null),P=null,e.onHeartRateChange(0),e.onDisconnected&&e.onDisconnected()},e.addEventListener("gattserverdisconnected",H);try{let a=e.gatt.connected?e.gatt:await e.gatt.connect(),o=await _(e);n.hrDeviceName&&(n.hrDeviceName.textContent=`Device: ${o}`);let r=await a.getPrimaryService("heart_rate");if(q=await r.getCharacteristic("heart_rate_measurement"),j)try{q.removeEventListener("characteristicvaluechanged",j)}catch(e){console.warn("Error removing old HR characteristic listener:",e)}await q.startNotifications(),j=e=>{!function(e,t){try{let n=e.target.value,a=function(e){if(!e||!(e instanceof DataView))throw Error("Invalid heart rate data: value must be a DataView");if(e.byteLength<2)throw Error(`Invalid heart rate data: insufficient data (${e.byteLength} bytes)`);let t=e.getUint8(0);if((1&t)!=0){if(e.byteLength<3)throw Error(`Invalid heart rate data: insufficient data for UINT16 format (${e.byteLength} bytes)`);let t=e.getUint16(1,!0);return t>300&&console.warn(`Unusually high heart rate detected: ${t} BPM`),t}let n=e.getUint8(1);return n>250&&console.warn(`Unusually high heart rate detected: ${n} BPM`),n}(n);if(isNaN(a)||a<0)return void console.error("Invalid heart rate value:",a);t.onHeartRateChange(a)}catch(e){console.error("Error parsing heart rate data:",e.message)}}(e,t)},q.addEventListener("characteristicvaluechanged",j),t.onStatusUpdate("Connected!"),n.hrConnectionStatus&&(n.hrConnectionStatus.textContent="Connected")}catch(t){if(q&&j){try{q.removeEventListener("characteristicvaluechanged",j)}catch(e){}j=null,q=null}throw e.removeEventListener("gattserverdisconnected",H),H=null,t}}async function _(e){let t=e.name||"Unknown Device";try{let n=e.gatt.connected?e.gatt:await e.gatt.connect();try{let e=await n.getPrimaryService("device_information"),a=await ee(e,"manufacturer_name_string");a&&(t+=` (${a})`);let o=await ee(e,"model_number_string");o&&(t+=` ${o}`)}catch(e){}}catch(e){}return e.id&&(t+=` [${e.id.slice(-6)}]`),t}async function ee(e,t){try{let n=await e.getCharacteristic(t),a=await n.readValue();return new TextDecoder().decode(a)}catch(e){return null}}async function et(e,t){if(await N(),!navigator.bluetooth)return void e.onStatusUpdate("Web Bluetooth API is not available.");try{e.onStatusUpdate("Scanning for sensors..."),t.cadenceConnectionStatus&&(t.cadenceConnectionStatus.textContent="Connecting..."),G&&(clearTimeout(G),G=null),z=0,Z=0,F=await navigator.bluetooth.requestDevice({filters:[{services:[R]}]}),e.onStatusUpdate("Connecting to device..."),t.cadenceDeviceName&&(t.cadenceDeviceName.textContent=`Device: ${F.name}`),F.addEventListener("gattserverdisconnected",()=>{var n,a;n=e,a=t,n.onStatusUpdate("Device disconnected."),a.cadenceConnectionStatus&&(a.cadenceConnectionStatus.textContent="Disconnected"),a.cadenceDeviceName&&(a.cadenceDeviceName.textContent=""),F=null,n.onCadenceChange(0),n.onDisconnected&&n.onDisconnected(),G&&(clearTimeout(G),G=null),z=0,Z=0});let n=await F.gatt.connect(),a=await n.getPrimaryService(R),o=await a.getCharacteristic("csc_measurement");return await o.startNotifications(),o.addEventListener("characteristicvaluechanged",t=>{!function(e,t){let n=e.target.value,a=n.getUint8(0),o=1;if(1&a&&(o+=6),2&a){let e=n.getUint16(o,!0),a=n.getUint16(o+2,!0);if(z>0){let n=e-z,o=(a-Z)/1024;if(o>0){let e=Math.round(n/o*60);t.onCadenceChange(e),G&&clearTimeout(G),G=setTimeout(()=>{t.onCadenceChange(0),G=null},3e3)}}z=e,Z=a}}(t,e)}),e.onStatusUpdate("Connected!"),t.cadenceConnectionStatus&&(t.cadenceConnectionStatus.textContent="Connected"),!0}catch(n){return e.onStatusUpdate(`Error: ${n.message}`),t.cadenceConnectionStatus&&(t.cadenceConnectionStatus.textContent="Connection Failed"),console.error("Speed/Cadence connection failed:",n),!1}}async function en(e){if(!navigator.bluetooth)return console.error("Web Bluetooth API is not available."),!1;try{if(e.spyInstructionsElement&&(e.spyInstructionsElement.style.display="none"),e.spyStatusElement&&(e.spyStatusElement.textContent="Scanning for spy power meter...",e.spyStatusElement.style.display="block"),J&&(W&&(J.removeEventListener("gattserverdisconnected",W),W=null),J.gatt.connected&&J.gatt.disconnect(),J=null),!(J=await navigator.bluetooth.requestDevice({filters:[{services:[V]}]})))throw Error("No device selected");e.spyStatusElement&&(e.spyStatusElement.textContent="Connecting to spy device..."),W=()=>{var t;t=e,J&&W&&(J.removeEventListener("gattserverdisconnected",W),W=null),J=null,t.spyValueElement&&(t.spyValueElement.textContent="--"),t.spyStatusElement&&(t.spyStatusElement.textContent="Spy disconnected",t.spyStatusElement.style.display="block"),setTimeout(()=>{t.spyStatusElement&&(t.spyStatusElement.style.display="none"),t.spyInstructionsElement&&(t.spyInstructionsElement.style.display="block")},3e3)},J.addEventListener("gattserverdisconnected",W);let t=await J.gatt.connect(),n=await t.getPrimaryService(V),a=await n.getCharacteristic(U);return await a.startNotifications(),a.addEventListener("characteristicvaluechanged",t=>{!function(e,t){try{let n=e.target.value;if(!n||!(n instanceof DataView))return void console.error("Invalid spy power measurement data: value must be a DataView");if(n.byteLength<4)return void console.error(`Invalid spy power measurement data: insufficient data (${n.byteLength} bytes)`);let a=n.getInt16(2,!0);if(isNaN(a))return void console.error("Invalid spy power value: NaN");a>3e3?console.warn(`Unusually high spy power detected: ${a}W`):a<-500&&console.warn(`Unusually low spy power detected: ${a}W`),t.spyValueElement&&(t.spyValueElement.textContent=a)}catch(e){console.error("Error parsing spy power measurement data:",e.message)}}(t,e)}),e.spyStatusElement&&(e.spyStatusElement.textContent="Spy connected!",e.spyStatusElement.style.display="none"),!0}catch(t){return"NotFoundError"===t.name?e.spyStatusElement&&(e.spyStatusElement.textContent="No device selected"):(e.spyStatusElement&&(e.spyStatusElement.textContent=`Spy Error: ${t.message}`),console.error("Spy connection failed:",t)),J&&(W&&(J.removeEventListener("gattserverdisconnected",W),W=null),J=null),setTimeout(()=>{e.spyStatusElement&&(e.spyStatusElement.style.display="none"),e.spyInstructionsElement&&(e.spyInstructionsElement.style.display="block")},3e3),!1}}function ea(e){J&&J.gatt.connected&&J.gatt.disconnect(),J=null,e.spyValueElement&&(e.spyValueElement.textContent="--"),e.spyStatusElement&&(e.spyStatusElement.style.display="none"),e.spyInstructionsElement&&(e.spyInstructionsElement.style.display="block")}function eo(e){return void 0!==e.power&&e.power>0}function er(e){let t={time:e=>`<Time>${new Date(e).toISOString()}</Time>`,heartRate:e=>`<HeartRateBpm>
      <Value>${Math.round(e)}</Value>
    </HeartRateBpm>`,cadence:e=>`<Cadence>${Math.round(e)}</Cadence>`,power:e=>{let t=Math.max(0,Math.min(2e3,Math.round(e)));return`<Extensions>
      <TPX xmlns="http://www.garmin.com/xmlschemas/ActivityExtension/v2">
        <Watts>${t}</Watts>
      </TPX>
    </Extensions>`}},n=Object.keys(t).map(n=>void 0===e[n]?"":t[n](e[n])).filter(Boolean).join("\n");return`<Trackpoint>
${n}
</Trackpoint>`}function ec(e){return{time:e.timestamp,...void 0!==e.power&&{power:e.power},...void 0!==e.heartRate&&{heartRate:e.heartRate},...void 0!==e.cadence&&{cadence:e.cadence}}}function es(e){if(!e)throw Error("Power data is null or undefined");if(!Array.isArray(e))throw Error("Power data must be an array");if(0===e.length)throw Error("Power data array is empty");let t=e.filter(e=>!e||"object"!=typeof e||void 0===e.timestamp);if(t.length>0)throw Error(`Power data contains ${t.length} invalid item(s)`);return!0}function ei(e){es(e),eu(new Blob([JSON.stringify(e,null,2)],{type:"application/json;charset=utf-8;"}),`power_data_${Q()}.json`)}function el(e){es(e);let t="timestamp,power,heartRate,cadence\n";e.forEach(e=>{let n=e.timestamp??"",a=e.power??"",o=e.heartRate??"",r=e.cadence??"";t+=`${n},${a},${o},${r}
`}),eu(new Blob([t],{type:"text/csv;charset=utf-8;"}),`power_data_${Q()}.csv`)}function ed(e){es(e);try{let t=function(e){if(!Array.isArray(e)||0===e.length)return"";let t=e.filter(e=>{var t;return e&&"object"==typeof e&&void 0!==(t=e.timestamp)&&!isNaN(new Date(t).getTime())});if(0===t.length)return"";let n=function(e){let t=[...e];for(;t.length>0&&!eo(t[0]);)t.shift();for(;t.length>0&&!eo(t[t.length-1]);)t.pop();return t}(t.map(ec).sort((e,t)=>e.time-t.time));if(0===n.length)return"";let a=n.map(er).join("\n"),o=new Date(n[0].time).toISOString(),r=function(e){if(0===e.length)return 0;let t=e[0].time;return Math.round((e[e.length-1].time-t)/1e3)}(n);return`<?xml version="1.0" encoding="UTF-8"?>
<TrainingCenterDatabase
  xmlns="http://www.garmin.com/xmlschemas/TrainingCenterDatabase/v2"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.garmin.com/xmlschemas/TrainingCenterDatabase/v2
    http://www.garmin.com/xmlschemas/TrainingCenterDatabasev2.xsd">
  <Activities>
    <Activity Sport="Biking">
      <Id>${o}</Id>
      <Lap StartTime="${o}">
        <TotalTimeSeconds>${r}</TotalTimeSeconds>
        <DistanceMeters>0</DistanceMeters>
        <Calories>0</Calories>
        <Intensity>Active</Intensity>
        <TriggerMethod>Manual</TriggerMethod>
        <Track>
${a}
        </Track>
      </Lap>
    </Activity>
  </Activities>
</TrainingCenterDatabase>`}(e);if(!t)throw Error("Failed to generate TCX content");let n=new Blob([t],{type:"application/vnd.garmin.tcx+xml;charset=utf-8;"});eu(n,`power_data_${Q()}.tcx`)}catch(e){throw console.error("Error generating TCX:",e),e}}function eu(e,t){try{if(!e||!(e instanceof Blob))throw Error("Invalid blob provided for download");if(!t||"string"!=typeof t)throw Error("Invalid filename provided for download");let n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}catch(e){throw console.error("Error during file download:",e),e}}async function em(e){let{powerData:t}=e;es(t);let n=[];for(let{name:e,fn:a}of[{name:"Summary JSON",fn:()=>ei(t)},{name:"Summary CSV",fn:()=>el(t)},{name:"TCX",fn:()=>ed(t)}]){try{a(),console.log(`\u{2713} ${e} exported`)}catch(t){n.push(`${e}: ${t.message}`)}await new Promise(e=>setTimeout(e,100))}if(n.length>0){let e=`Some exports failed:
${n.join("\n")}`;throw console.warn("Export errors:",n),Error(e)}console.log("✅ All exports completed successfully!")}function eg(e,t){let n=`Error during ${t} export: ${e.message}`;console.error(n,e),alert(n)}function ep(e,t){let n=document.createElement("div");return n.className="export-modal",n.innerHTML=`
        <div class="export-modal-content">
            <div class="export-modal-header">
                <h3 class="export-modal-title">${e}</h3>
                <button class="export-modal-close" aria-label="Close modal">&times;</button>
            </div>
            <div class="export-modal-description">${t}</div>
            <div class="export-modal-buttons"></div>
        </div>
    `,n.querySelector(".export-modal-close").addEventListener("click",()=>eA(n)),n.addEventListener("click",e=>{e.target===n&&eA(n)}),n}function eh(e,t){let n=e.querySelector(".export-modal-buttons");t.forEach(e=>{let t=document.createElement("button");if(t.className=`export-modal-button ${e.className||""}`,t.disabled=e.disabled||!1,t.innerHTML=`
            <span>${e.text}</span>
            ${e.description?`<small style="opacity: 0.7; font-size: 0.8em;">${e.description}</small>`:""}
        `,t.addEventListener("click",e.onClick),n.appendChild(t),e.className&&e.className.includes("export-all")){let e=document.createElement("div");e.className="export-modal-separator",e.innerHTML="<span>Individual Exports</span>",n.appendChild(e)}})}function ey(e){document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("show")})}function eA(e){e.classList.remove("show"),setTimeout(()=>{e.parentNode&&document.body.removeChild(e)},300)}function ev(e,t,n=!0,a=null){let o=n;n?(e.classList.add("active"),t.style.display="block"):(e.classList.remove("active"),t.style.display="none");let r=()=>{(o=!o)?(t.style.display="block",e.classList.add("active")):(t.style.display="none",e.classList.remove("active")),a&&a()};return e.addEventListener("click",r),()=>e.removeEventListener("click",r)}function ew(){let e=document.querySelector(".dashboard");if(!e)return;let t=document.querySelector(".collapsed-sections-row");t&&(t.querySelectorAll(".power-averages-section").forEach(t=>{e.parentNode.insertBefore(t,e.nextSibling)}),t.remove()),e.classList.remove("has-collapsed-sections")}function eE(e,t){let n=document.createElement("div");n.className="metric-info-modal",n.innerHTML=`
        <div class="metric-info-content">
            <div class="metric-info-header">
                <h3>${e}</h3>
                <button class="metric-info-close" aria-label="Close">\xd7</button>
            </div>
            <div class="metric-info-body">
                <p>${t}</p>
            </div>
        </div>
    `,document.body.appendChild(n),setTimeout(()=>n.classList.add("active"),10);let a=n.querySelector(".metric-info-close"),o=()=>{n.classList.remove("active"),setTimeout(()=>n.remove(),300)};a.addEventListener("click",o),n.addEventListener("click",e=>{e.target===n&&o()});let r=e=>{"Escape"===e.key&&(o(),document.removeEventListener("keydown",r))};document.addEventListener("keydown",r)}let ef=[],eC=0,eS=0,eI=0,ex=null,eb=null,eB=null;const eD={get powerData(){return ef},get lastPowerValue(){return eC},get lastHeartRateValue(){return eS},get lastCadenceValue(){return eI},get sessionStartTime(){return ex},resetAllSessionData:function(){ef.length=0,M(),eC=0,eS=0,eI=0,ex=null,T(),C()},elements:k},eM={onPowerMeasurement:e=>{L(e),eC=e,function(e){if("number"!=typeof e||isNaN(e))return console.error("Invalid power reading: must be a number",e);e>3e3?console.warn(`Unusually high power reading: ${e}W`):e<-500&&console.warn(`Unusually low power reading: ${e}W`);let t=Date.now();I.push({timestamp:t,power:e});let n=t-36e4;if(I=I.filter(e=>e.timestamp>n),x.push({timestamp:t,power:e}),x.length>0&&x[0].timestamp<=t-1e4){let e=Math.round(x.reduce((e,t)=>e+t.power,0)/x.length);for(b.push(e),x.splice(0,x.length);b.length>30;)b.shift();for(let[e,t]of Object.entries(S)){let n=Math.ceil(t/1e4);if(b.length>=n){let t=Math.round(b.slice(-n).reduce((e,t)=>e+t,0)/n);B[e].current=t,t>B[e].best&&(B[e].best=t)}else B[e].current=0}D()}}(e)},onDisconnected:()=>{T(),M(),eb&&(clearInterval(eb),eb=null),eC=0,eT()},onStatusUpdate:e=>{k.statusText&&(k.statusText.textContent=e)}},ek={onHeartRateChange:e=>{k.hrValueElement&&(k.hrValueElement.textContent=e),eS=e},onStatusUpdate:e=>{k.hrStatusText&&(k.hrStatusText.textContent=e)},onDisconnected:()=>{eT()}},eL={onCadenceChange:e=>{k.cadenceValueElement&&(k.cadenceValueElement.textContent=e),eI=e},onStatusUpdate:e=>{k.cadenceStatusText&&(k.cadenceStatusText.textContent=e)},onDisconnected:()=>{eT()}};function eT(){var e;e={powerMeter:Y&&Y.gatt.connected,heartRate:P&&P.gatt.connected,speedCadence:F&&F.gatt.connected},k.powerMeterConnectButton&&(k.powerMeterConnectButton.style.display=e.powerMeter?"none":"block"),k.hrConnectButton&&(k.hrConnectButton.style.display=e.heartRate?"none":"block"),k.speedCadenceConnectButton&&(k.speedCadenceConnectButton.style.display=e.speedCadence?"none":"block")}async function eQ(){try{k.powerValueElement=document.getElementById("power-value"),k.hrValueElement=document.getElementById("hr-value"),k.cadenceValueElement=document.getElementById("cadence-value"),k.deviceNameElement=document.getElementById("device-name"),k.hrDeviceName=document.getElementById("hrDeviceName"),k.cadenceDeviceName=document.getElementById("cadenceDeviceName"),k.statusText=document.getElementById("status"),k.hrStatusText=document.getElementById("hrStatus"),k.cadenceStatusText=document.getElementById("cadenceStatus"),k.hrConnectionStatus=document.getElementById("hrConnectionStatus"),k.cadenceConnectionStatus=document.getElementById("cadenceConnectionStatus"),k.powerMeterConnectButton=document.getElementById("connectButton"),k.hrConnectButton=document.getElementById("hrConnectButton"),k.speedCadenceConnectButton=document.getElementById("speedCadenceConnectButton"),k.powerAveragesSection=document.getElementById("powerAveragesSection"),k.hamburgerBtn=document.getElementById("hamburgerButton"),k.menuDropdown=document.getElementById("menuDropdown"),k.powerAveragesToggle=document.getElementById("powerAveragesToggle"),k.powerMetricToggle=document.getElementById("powerMetricToggle"),k.heartRateMetricToggle=document.getElementById("heartRateMetricToggle"),k.cadenceMetricToggle=document.getElementById("cadenceMetricToggle"),k.showInfoMenuItem=document.getElementById("showInfoMenuItem"),k.spyModeToggle=document.getElementById("spyModeToggle"),k.powerCard=document.querySelector(".power-card"),k.heartRateCard=document.querySelector(".hr-card"),k.cadenceCard=document.querySelector(".cadence-card"),k.spyCard=document.querySelector(".spy-card"),k.spyModeSection=document.getElementById("spyModeSection"),k.spyValueElement=document.getElementById("spy-value"),k.spyStatusElement=document.getElementById("spyStatus"),k.spyInstructionsElement=document.getElementById("spyInstructions"),k.hrConnectionStatus&&(k.hrConnectionStatus.textContent="Disconnected"),k.cadenceConnectionStatus&&(k.cadenceConnectionStatus.textContent="Disconnected"),e=document.getElementById("avg10s-current"),t=document.getElementById("avg10s-best"),n=document.getElementById("avg20s-current"),a=document.getElementById("avg20s-best"),o=document.getElementById("avg30s-current"),r=document.getElementById("avg30s-best"),c=document.getElementById("avg40s-current"),s=document.getElementById("avg40s-best"),i=document.getElementById("avg50s-current"),l=document.getElementById("avg50s-best"),d=document.getElementById("avg1m-current"),u=document.getElementById("avg1m-best"),m=document.getElementById("avg2m-current"),g=document.getElementById("avg2m-best"),p=document.getElementById("avg3m-current"),h=document.getElementById("avg3m-best"),y=document.getElementById("avg4m-current"),A=document.getElementById("avg4m-best"),v=document.getElementById("avg5m-current"),w=document.getElementById("avg5m-best"),k.powerAveragesSection&&(k.powerAveragesSection.style.display="block");let S=document.querySelector(".dashboard"),I=document.getElementById("powerAveragesSection"),x=I&&"none"===I.style.display;S&&(x?S.classList.add("maximized"):S.classList.remove("maximized")),ew();let b=document.getElementById("powerIcon");b&&b.addEventListener("click",e=>{e.preventDefault(),eE("⚡ Power Output","Power output is measured in Watts and represents the amount of work you are doing on the bike. It is calculated by measuring the force applied to the pedals and the speed of pedaling. Higher power output means you are working harder. This metric is the most accurate way to measure cycling effort.")});let B=document.getElementById("hrIcon");B&&B.addEventListener("click",e=>{e.preventDefault(),eE("❤️ Heart Rate","Heart rate is measured in beats per minute (BPM) and indicates how hard your cardiovascular system is working. Your heart rate increases as exercise intensity increases. Monitoring heart rate helps you train in specific zones for different fitness goals. Connect a Bluetooth heart rate monitor to track this metric.")});let T=document.getElementById("cadenceIcon");T&&T.addEventListener("click",e=>{e.preventDefault(),eE("\uD83D\uDEB4 Cadence","Cadence is measured in revolutions per minute (RPM) and represents how fast you are pedaling. Most cyclists aim for a cadence between 80-100 RPM for optimal efficiency. Higher cadence with lower resistance can reduce muscle fatigue, while lower cadence with higher resistance builds strength. Connect a speed & cadence sensor to track this metric.")}),function(e){if(!e.hamburgerBtn||!e.menuDropdown)return console.error("Hamburger menu elements not found:",{hamburgerBtn:!!e.hamburgerBtn,menuDropdown:!!e.menuDropdown});e.hamburgerBtn.addEventListener("click",function(){e.menuDropdown.classList.contains("active")?e.menuDropdown.classList.remove("active"):e.menuDropdown.classList.add("active")}),document.addEventListener("click",function(t){t.target.closest(".hamburger-menu")||e.menuDropdown.classList.remove("active")})}(k),function(e){if(!e.powerAveragesToggle||!e.powerAveragesSection)return console.error("Power averages toggle elements not found:",{powerAveragesToggle:!!e.powerAveragesToggle,powerAveragesSection:!!e.powerAveragesSection});ev(e.powerAveragesToggle,e.powerAveragesSection,!0,ew)}(k),k.powerMetricToggle&&k.powerCard?ev(k.powerMetricToggle,k.powerCard,!0):console.error("Power metric toggle elements not found"),k.heartRateMetricToggle&&k.heartRateCard?ev(k.heartRateMetricToggle,k.heartRateCard,!0):console.error("Heart rate metric toggle elements not found"),k.cadenceMetricToggle&&k.cadenceCard?ev(k.cadenceMetricToggle,k.cadenceCard,!0):console.error("Cadence metric toggle elements not found"),function(e,t){if(!e.spyModeToggle||!e.spyModeSection)return console.error("Spy mode toggle elements not found");let n=!1;e.spyModeToggle.addEventListener("click",function(){(n=!n)?(e.spyModeSection.style.display="block",e.spyModeToggle.classList.add("active")):(e.spyModeSection.style.display="none",e.spyModeToggle.classList.remove("active"),t(),e.spyValueElement&&(e.spyValueElement.textContent="--"),e.spyStatusElement&&(e.spyStatusElement.style.display="none")),e.spyInstructionsElement&&(e.spyInstructionsElement.style.display="block")})}(k,()=>ea(k)),k.showInfoMenuItem?k.showInfoMenuItem.addEventListener("click",function(){!function(){let e=document.createElement("div");e.className="modal-backdrop",e.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;let t=document.createElement("div");t.className="modal",t.style.cssText=`
        background: #1a1a2e;
        border-radius: 12px;
        padding: 2rem;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        margin: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    `;let n=document.createElement("canvas");n.width=200,n.height=200,n.style.cssText=`
        background: white;
        border-radius: 8px;
        margin: 1rem auto;
        max-width: 100%;
        height: auto;
        display: block;
    `,t.innerHTML=`
        <div style="text-align: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0 0 0.5rem 0; font-size: 1.8rem;">\u{1F6B4} Web Bluetooth Power Meter</h2>
            <p style="color: #cccccc; margin: 0; font-size: 1rem;">Real-time cycling data analysis</p>
        </div>

        <div style="color: #ffffff; line-height: 1.6;">
            <h3 style="color: #f39c12; margin: 1.5rem 0 1rem 0;">\u{1F4F1} Share This App</h3>
            <div style="text-align: center; margin-bottom: 1rem;">
                <div id="qr-container" style="margin: 1rem 0;"></div>
                <p style="color: #ffffff; margin: 0.5rem 0; font-weight: 600;">Scan to access on any device</p>
                <a href="https://colscoding.github.io/power-saver/" target="_blank" style="
                    color: #9b59b6; 
                    text-decoration: none; 
                    font-size: 0.9rem;
                    word-break: break-all;
                    line-height: 1.4;
                ">https://colscoding.github.io/power-saver/</a>
            </div>

            <h3 style="color: #f39c12; margin: 1.5rem 0 1rem 0;">\u{1F4F1} What is this app?</h3>
            <p style="margin-bottom: 1rem;">
                This is a web-based power meter application that connects to Bluetooth devices:
            </p>
            <ul style="margin: 0 0 1rem 1rem; padding-left: 1rem;">
                <li>cycling power meter</li>
                <li>cadence sensor</li>
                <li>heart rate sensor</li>
            </ul>
        </div>

        <div style="text-align: center; margin-top: 2rem;">
            <button id="closeInfoModal" style="
                background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            ">Got it!</button>
        </div>
    `,t.querySelector("#qr-container").appendChild(n),function(e){let t=e.getContext("2d"),n=e.width;t.fillStyle="#ffffff",t.fillRect(0,0,n,n);let a=new Image;a.onload=function(){t.drawImage(a,0,0,n,n)},a.onerror=function(){var e=t,a=n;e.fillStyle="#000000",e.font="12px Arial",e.textAlign="center";let o=a/25;for(let t=0;t<25;t++)for(let n=0;n<25;n++)((t+n)%3==0||0===t||24===t||0===n||24===n)&&e.fillRect(t*o,n*o,o,o);e.fillStyle="#ffffff",e.fillRect(.2*a,.4*a,.6*a,.2*a),e.fillStyle="#000000",e.fillText("QR Code",a/2,a/2-10),e.fillText("Unavailable",a/2,a/2+10)},a.src="data:image/png;base64,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"}(n),e.appendChild(t),document.body.appendChild(e);let a=t.querySelector("#closeInfoModal"),o=()=>{document.body.removeChild(e)};a.addEventListener("click",o),e.addEventListener("click",t=>{t.target===e&&o()});let r=e=>{"Escape"===e.key&&(o(),document.removeEventListener("keydown",r))};document.addEventListener("keydown",r),a.addEventListener("mouseenter",()=>{a.style.transform="translateY(-2px)",a.style.boxShadow="0 8px 24px rgba(52, 152, 219, 0.4)"}),a.addEventListener("mouseleave",()=>{a.style.transform="translateY(0)",a.style.boxShadow="none"})}(),k.menuDropdown&&k.menuDropdown.classList.remove("active")}):console.error("Show info menu item not found"),k.powerMeterConnectButton&&k.powerMeterConnectButton.addEventListener("click",async()=>{ef.length=0,eC=0,M(),eb&&clearInterval(eb),await K(eM,k)&&(ex||(ex=Date.now()),eb=setInterval(()=>{ef.push({timestamp:Date.now(),power:eC,heartRate:eS,cadence:eI}),ef.length%100==0&&f(eD)},100),eT())}),k.hrConnectButton&&k.hrConnectButton.addEventListener("click",async()=>{await X(ek,k)&&eT()}),k.speedCadenceConnectButton&&k.speedCadenceConnectButton.addEventListener("click",async()=>{await et(eL,k)&&eT()}),k.spyCard&&k.spyCard.addEventListener("click",async()=>{J&&J.gatt.connected?ea(k):await en(k)});let Q=document.getElementById("exportMenuItem");Q&&Q.addEventListener("click",()=>{let e=ep("\uD83D\uDCC4 Exports","Export your session data in various formats"),t=[{text:"\uD83D\uDCE5 Export All Files",description:"Download all export formats at once",className:"export-all primary",onClick:async()=>{try{await em({powerData:eD.powerData}),eA(e),alert("All export files downloaded successfully!")}catch(e){eg(e,"all files")}}},{text:"\uD83D\uDCCA Export JSON",description:"JavaScript Object Notation format",onClick:()=>{try{ei(eD.powerData),eA(e)}catch(e){eg(e,"JSON")}}},{text:"\uD83D\uDCCA Export CSV",description:"Comma-Separated Values format",onClick:()=>{try{el(eD.powerData),eA(e)}catch(e){eg(e,"CSV")}}},{text:"\uD83C\uDFC3 Export TCX",description:"Training Center XML format",onClick:()=>{try{ed(eD.powerData),eA(e)}catch(e){eg(e,"TCX")}}}];eh(e,t),ey(e)});let N=document.getElementById("exportUtilsMenuItem");N&&N.addEventListener("click",()=>{let e=ep("\uD83D\uDEE0️ Utilities","Session management and utilities"),t=[{text:"\uD83D\uDDD1️ Clear Session Data",description:"Clear all session data (cannot be undone)",className:"danger",onClick:()=>{confirm("Are you sure you want to clear all session data? This action cannot be undone.")&&(eD.resetAllSessionData(),alert("Session data cleared successfully!"),eA(e))}}];eh(e,t),ey(e)}),eT();let V=function(){try{let e=localStorage.getItem(E);if(!e)return null;let t=JSON.parse(e);if(!(t&&"object"==typeof t&&t.timestamp&&t.powerData&&Array.isArray(t.powerData)&&1))return console.warn("Invalid session data structure, clearing..."),localStorage.removeItem(E),null;if(Date.now()-t.timestamp>864e5)return console.log("Session expired, clearing..."),localStorage.removeItem(E),null;return t}catch(e){return console.warn("Failed to load session data:",e),localStorage.removeItem(E),null}}();V&&await new Promise(e=>{let t=document.createElement("div");t.className="modal-backdrop";let n=document.createElement("div");n.className="modal";let a=Math.round((Date.now()-V.timestamp)/6e4),o=V.powerData?.length||0;n.innerHTML=`
      <h3>Previous Session Found</h3>
      <p>
        A previous session was found from ${a} minutes ago with ${o} data points.
      </p>
      <p>
        Would you like to restore this session or start fresh?
      </p>
      <div class="modal-buttons">
        <button id="startFresh" class="modal-button secondary">Start Fresh</button>
        <button id="restoreSession" class="modal-button primary">Restore Session</button>
      </div>
    `,t.appendChild(n),document.body.appendChild(t),n.querySelector("#startFresh").addEventListener("click",()=>{document.body.removeChild(t),C(),e(!1)}),n.querySelector("#restoreSession").addEventListener("click",()=>{document.body.removeChild(t),e(!0)}),t.addEventListener("click",n=>{n.target===t&&(document.body.removeChild(t),e(!1))})})?function(e){try{var t;e.powerData&&(ef.length=0,ef.push(...e.powerData)),void 0!==e.lastPowerValue&&(eC=e.lastPowerValue),void 0!==e.lastHeartRateValue&&(eS=e.lastHeartRateValue),void 0!==e.lastCadenceValue&&(eI=e.lastCadenceValue),void 0!==e.sessionStartTime&&(ex=e.sessionStartTime),void 0!==(t={power:eC,heartRate:eS,cadence:eI}).power&&L(t.power),void 0!==t.heartRate&&k.hrValueElement&&(k.hrValueElement.textContent=t.heartRate||"--"),void 0!==t.cadence&&k.cadenceValueElement&&(k.cadenceValueElement.textContent=t.cadence||"--"),D(),ef.length>0&&function(e){if(!document.getElementById("notification-styles")){let e=document.createElement("style");e.id="notification-styles",e.textContent=`
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `,document.head.appendChild(e)}let t=function(e,t){let n=document.createElement("div");return n.style.cssText=`
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${t};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        z-index: 1000;
        font-size: 0.9rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease-out;
        max-width: 300px;
        word-wrap: break-word;
    `,n.textContent=e,n}(`Session restored! ${e} data points recovered.`,"#4CAF50");document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideIn 0.3s ease-out reverse",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},5e3)}(ef.length)}catch(e){return console.warn("Failed to restore session data:",e),!1}}(V):ex=Date.now(),window.addEventListener("beforeunload",eN),eB=setInterval(()=>{ef.length>0&&f(eD)},3e4)}catch(e){console.error("Failed to initialize application:",e),alert("Failed to initialize application. Please refresh the page.")}}function eN(){ef.length>0&&f(eD),eb&&(clearInterval(eb),eb=null),eB&&(clearInterval(eB),eB=null)}document.addEventListener("DOMContentLoaded",eQ);
//# sourceMappingURL=power-saver.21ba93c3.js.map

let e,t,n,a,o,r,l,s,i,c,d,m,u,g,p,A,f,h,y,w;const v="powerMeterSession";function C(e){try{let t={timestamp:Date.now(),powerData:e.powerData,heartData:e.heartData,cadenceData:e.cadenceData,rawPowerMeasurements:e.rawPowerMeasurements,powerReadings:e.getPowerReadings(),powerAverages:e.getPowerAverages(),lastPowerValue:e.lastPowerValue,lastHeartRateValue:e.lastHeartRateValue,lastCadenceValue:e.lastCadenceValue,sessionStartTime:e.sessionStartTime};localStorage.setItem(v,JSON.stringify(t))}catch(e){console.warn("Failed to save session data:",e)}}function E(){localStorage.removeItem(v)}let S=[],x={"10s":{current:0,best:0},"20s":{current:0,best:0},"30s":{current:0,best:0},"40s":{current:0,best:0},"50s":{current:0,best:0},"1m":{current:0,best:0},"2m":{current:0,best:0},"3m":{current:0,best:0},"4m":{current:0,best:0},"5m":{current:0,best:0}};function b(){e&&(e.textContent=x["10s"].current||"--",t.textContent=x["10s"].best||"--",n.textContent=x["20s"].current||"--",a.textContent=x["20s"].best||"--",o.textContent=x["30s"].current||"--",r.textContent=x["30s"].best||"--",l.textContent=x["40s"].current||"--",s.textContent=x["40s"].best||"--",i.textContent=x["50s"].current||"--",c.textContent=x["50s"].best||"--",d.textContent=x["1m"].current||"--",m.textContent=x["1m"].best||"--",u.textContent=x["2m"].current||"--",g.textContent=x["2m"].best||"--",p.textContent=x["3m"].current||"--",A.textContent=x["3m"].best||"--",f.textContent=x["4m"].current||"--",h.textContent=x["4m"].best||"--",y.textContent=x["5m"].current||"--",w.textContent=x["5m"].best||"--")}function I(){for(let e of(S=[],Object.keys(x)))x[e].current=0,x[e].best=0;b()}const B={powerValueElement:null,hrValueElement:null,cadenceValueElement:null,deviceNameElement:null,hrDeviceName:null,cadenceDeviceName:null,statusText:null,hrStatusText:null,cadenceStatusText:null,hrConnectionStatus:null,cadenceConnectionStatus:null,powerMeterConnectButton:null,hrConnectButton:null,speedCadenceConnectButton:null,exportButtons:{json:null,csv:null,tcx:null,rawJson:null,rawCsv:null,image:null,clearSession:null},powerAveragesSection:null,hamburgerBtn:null,menuDropdown:null,powerAveragesToggle:null,powerMetricToggle:null,heartRateMetricToggle:null,cadenceMetricToggle:null,showInfoMenuItem:null,spyModeToggle:null,powerCard:null,heartRateCard:null,cadenceCard:null,spyCard:null,spyModeSection:null,spyValueElement:null,spyStatusElement:null,spyInstructionsElement:null};function D(e){if(!B.powerValueElement)return;let t=e||"--";B.powerValueElement.textContent=t,B.powerValueElement.setAttribute("data-value",t)}function M(){D("--"),B.hrValueElement&&(B.hrValueElement.textContent="--"),B.cadenceValueElement&&(B.cadenceValueElement.textContent="--")}function T(){let e=new Date,t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${t}-${n}-${a}`}async function k(){if("wakeLock"in navigator)try{(await navigator.wakeLock.request("screen")).addEventListener("release",()=>{console.log("Wake lock was released")})}catch(e){console.error(`${e.name}, ${e.message}`)}}const L="cycling_power",Q="cycling_power_measurement",R="cycling_speed_and_cadence";let P=null,N=null,V=null,U=null,Y=0,J=0,F=null;async function O(e,t){if(await k(),!navigator.bluetooth)return void e.onStatusUpdate("Web Bluetooth API is not available.");try{e.onStatusUpdate("Scanning for power meters..."),P=await navigator.bluetooth.requestDevice({filters:[{services:[L]}]}),e.onStatusUpdate("Connecting to device..."),t.deviceNameElement&&(t.deviceNameElement.textContent=`Device: ${P.name||"Unknown Device"}`),P.addEventListener("gattserverdisconnected",()=>{z(e,t)});let n=await P.gatt.connect(),a=await n.getPrimaryService(L),o=await a.getCharacteristic(Q);try{let e=await a.getCharacteristic("cycling_power_feature");await e.readValue()}catch{}return await o.startNotifications(),o.addEventListener("characteristicvaluechanged",t=>{var n=t,a=e;let o=n.target.value,r={timestamp:Date.now(),flags:o.getUint16(0,!0),rawBytes:Array.from(new Uint8Array(o.buffer)).map(e=>e.toString(16).padStart(2,"0")).join(" "),dataLength:o.byteLength};o.getUint16(0,!0);let l=o.getInt16(2,!0);r.instantaneousPower=l,a.onPowerMeasurement(l,r)}),e.onStatusUpdate("Connected and receiving data!"),!0}catch(n){return e.onStatusUpdate(`Error: ${n.message}`),console.error("Connection failed:",n),P&&P.removeEventListener("gattserverdisconnected",()=>{z(e,t)}),!1}}async function W(e,t){if(await k(),!navigator.bluetooth)return void e.onStatusUpdate("Web Bluetooth API is not available.");try{e.onStatusUpdate("Scanning for devices..."),t.hrConnectionStatus&&(t.hrConnectionStatus.textContent="Connecting..."),N=await navigator.bluetooth.requestDevice({filters:[{services:["heart_rate"]}]}),e.onStatusUpdate("Connecting to device..."),t.hrDeviceName&&(t.hrDeviceName.textContent=`Device: ${N.name}`),N.addEventListener("gattserverdisconnected",()=>{var n,a;n=e,a=t,n.onStatusUpdate("Device disconnected."),a.hrConnectionStatus&&(a.hrConnectionStatus.textContent="Disconnected"),a.hrDeviceName&&(a.hrDeviceName.textContent=""),N=null,n.onHeartRateChange(0),n.onDisconnected&&n.onDisconnected()});let n=await N.gatt.connect(),a=await n.getPrimaryService("heart_rate"),o=await a.getCharacteristic("heart_rate_measurement");return await o.startNotifications(),o.addEventListener("characteristicvaluechanged",t=>{var n=t,a=e;let o=function(e){let t=e.getUint8(0);return 1&t?e.getUint16(1,!0):e.getUint8(1)}(n.target.value);a.onHeartRateChange(o)}),e.onStatusUpdate("Connected!"),t.hrConnectionStatus&&(t.hrConnectionStatus.textContent="Connected"),!0}catch(n){return e.onStatusUpdate(`Error: ${n.message}`),t.hrConnectionStatus&&(t.hrConnectionStatus.textContent="Connection Failed"),console.error("Connection failed:",n),!1}}async function j(e,t){if(await k(),!navigator.bluetooth)return void e.onStatusUpdate("Web Bluetooth API is not available.");try{e.onStatusUpdate("Scanning for sensors..."),t.cadenceConnectionStatus&&(t.cadenceConnectionStatus.textContent="Connecting..."),F&&(clearTimeout(F),F=null),Y=0,J=0,V=await navigator.bluetooth.requestDevice({filters:[{services:[R]}]}),e.onStatusUpdate("Connecting to device..."),t.cadenceDeviceName&&(t.cadenceDeviceName.textContent=`Device: ${V.name}`),V.addEventListener("gattserverdisconnected",()=>{var n,a;n=e,a=t,n.onStatusUpdate("Device disconnected."),a.cadenceConnectionStatus&&(a.cadenceConnectionStatus.textContent="Disconnected"),a.cadenceDeviceName&&(a.cadenceDeviceName.textContent=""),V=null,n.onCadenceChange(0),n.onDisconnected&&n.onDisconnected(),F&&(clearTimeout(F),F=null),Y=0,J=0});let n=await V.gatt.connect(),a=await n.getPrimaryService(R),o=await a.getCharacteristic("csc_measurement");return await o.startNotifications(),o.addEventListener("characteristicvaluechanged",t=>{!function(e,t){let n=e.target.value,a=n.getUint8(0),o=1;if(1&a&&(o+=6),2&a){let e=n.getUint16(o,!0),a=n.getUint16(o+2,!0);if(Y>0){let n=e-Y,o=(a-J)/1024;if(o>0){let e=Math.round(n/o*60);t.onCadenceChange(e),F&&clearTimeout(F),F=setTimeout(()=>{t.onCadenceChange(0),F=null},3e3)}}Y=e,J=a}}(t,e)}),e.onStatusUpdate("Connected!"),t.cadenceConnectionStatus&&(t.cadenceConnectionStatus.textContent="Connected"),!0}catch(n){return e.onStatusUpdate(`Error: ${n.message}`),t.cadenceConnectionStatus&&(t.cadenceConnectionStatus.textContent="Connection Failed"),console.error("Speed/Cadence connection failed:",n),!1}}async function q(e,t){if(!navigator.bluetooth)return void console.error("Web Bluetooth API is not available.");try{t.spyInstructionsElement&&(t.spyInstructionsElement.style.display="none"),t.spyStatusElement&&(t.spyStatusElement.textContent="Scanning for spy power meter...",t.spyStatusElement.style.display="block"),U=await navigator.bluetooth.requestDevice({filters:[{services:[L]}]}),t.spyStatusElement&&(t.spyStatusElement.textContent="Connecting to spy device..."),U.addEventListener("gattserverdisconnected",()=>{Z(t)});let e=await U.gatt.connect(),n=await e.getPrimaryService(L),a=await n.getCharacteristic(Q);return await a.startNotifications(),a.addEventListener("characteristicvaluechanged",e=>{var n=e,a=t;let o=new Uint8Array(n.target.value.buffer),r=0;o.length>=4&&(r=o[2]+(o[3]<<8)),a.spyValueElement&&(a.spyValueElement.textContent=r)}),t.spyStatusElement&&(t.spyStatusElement.textContent="Spy connected!",t.spyStatusElement.style.display="none"),!0}catch(e){return t.spyStatusElement&&(t.spyStatusElement.textContent=`Spy Error: ${e.message}`),console.error("Spy connection failed:",e),U&&(U.removeEventListener("gattserverdisconnected",()=>{Z(t)}),U=null),setTimeout(()=>{t.spyStatusElement&&(t.spyStatusElement.style.display="none"),t.spyInstructionsElement&&(t.spyInstructionsElement.style.display="block")},3e3),!1}}function H(e){U&&U.gatt.connected&&U.gatt.disconnect(),U=null,e.spyValueElement&&(e.spyValueElement.textContent="--"),e.spyStatusElement&&(e.spyStatusElement.style.display="none"),e.spyInstructionsElement&&(e.spyInstructionsElement.style.display="block")}function z(e,t){e.onStatusUpdate("Device disconnected."),t.deviceNameElement&&(t.deviceNameElement.textContent=""),P&&(P.removeEventListener("gattserverdisconnected",()=>{z(e,t)}),P=null),e.onDisconnected()}function Z(e){U=null,e.spyValueElement&&(e.spyValueElement.textContent="--"),e.spyStatusElement&&(e.spyStatusElement.textContent="Spy disconnected",e.spyStatusElement.style.display="block"),setTimeout(()=>{e.spyStatusElement&&(e.spyStatusElement.style.display="none"),e.spyInstructionsElement&&(e.spyInstructionsElement.style.display="block")},3e3)}function G(e){let t={time:e=>`<Time>${new Date(e).toISOString()}</Time>`,heartRate:e=>`
<HeartRateBpm>
  <Value>${e}</Value>
</HeartRateBpm>
            `.trim(),cadence:e=>`<Cadence>${e}</Cadence>`,power:e=>`
<Extensions>
  <ns2:TPX>
    <ns2:Watts>${e}</ns2:Watts>
  </ns2:TPX>
</Extensions>
            `.trim()},n=Object.keys(t).map(n=>void 0===e[n]?"":t[n](e[n])).filter(e=>e).join("\n");return`
<Trackpoint>
  ${n}
</Trackpoint>
`.trim()}async function K({dataPoints:e,powerAverages:t}){let n=e.filter(e=>void 0!==e.heartRate),a=e.filter(e=>void 0!==e.cadence),o=e.filter(e=>void 0!==e.power),r=document.createElement("canvas"),l=r.getContext("2d"),s=200;Object.values(t).some(e=>e.current>0||e.best>0)&&(s+=200),n.length>0&&n.some(e=>e.heartRate>0)&&(s+=140),a.length>0&&a.some(e=>e.cadence>0)&&(s+=140),o.length>0&&(s+=350),n.length>0&&(s+=350),a.length>0&&(s+=350);let i=Math.max(600,s);r.width=1200,r.height=i,l.fillStyle="#1a1a2e",l.fillRect(0,0,1200,i),l.fillStyle="#ffffff",l.font="bold 36px Arial, sans-serif",l.textAlign="center",l.fillText("Power Meter Summary",600,50),l.font="18px Arial, sans-serif",l.fillStyle="#cccccc";let c=new Date;if(l.fillText(c.toLocaleDateString()+" "+c.toLocaleTimeString(),600,80),o.length>0){let e=Math.round(Math.round((o[o.length-1].timestamp-o[0].timestamp)/1e3)/60);l.fillText(`Session Duration: ${e} minutes`,600,105)}let d=130;if(Object.values(t).some(e=>e.current>0||e.best>0)){l.fillStyle="#ffffff",l.font="bold 24px Arial, sans-serif",l.textAlign="left",l.fillText("Power Averages",50,d),d+=40;let e=[{label:"10s",data:t["10s"]},{label:"30s",data:t["30s"]},{label:"1m",data:t["1m"]},{label:"2m",data:t["2m"]},{label:"4m",data:t["4m"]},{label:"8m",data:t["8m"]}];l.font="16px Arial, sans-serif",l.fillStyle="#cccccc",l.fillText("Duration",70,d),l.fillText("Best",220,d),l.fillText("Duration",470,d),l.fillText("Best",620,d),d+=30;for(let t=0;t<e.length;t++){let n=e[t],a=t<3?70:470,o=d+25*(t<3?t:t-3);l.fillStyle="#ffffff",l.fillText(n.label,a,o),l.fillStyle=n.data.best>0?"#e74c3c":"#666666",l.fillText(n.data.best+"W",a+150,o)}d+=100}if(n.length>0){let e=n.map(e=>e.heartRate).filter(e=>e>0);if(e.length>0){l.fillStyle="#ffffff",l.font="bold 24px Arial, sans-serif",l.textAlign="left",l.fillText("Heart Rate Statistics",50,d),d+=40;let t=Math.max(...e),n=Math.min(...e),a=Math.round(e.reduce((e,t)=>e+t,0)/e.length);l.font="16px Arial, sans-serif",l.fillStyle="#cccccc",l.fillText("Average:",70,d),l.fillStyle="#e74c3c",l.fillText(`${a} BPM`,200,d),d+=25,l.fillStyle="#cccccc",l.fillText("Maximum:",70,d),l.fillStyle="#e74c3c",l.fillText(`${t} BPM`,200,d),d+=25,l.fillStyle="#cccccc",l.fillText("Minimum:",70,d),l.fillStyle="#e74c3c",l.fillText(`${n} BPM`,200,d),d+=40}}if(a.length>0){let e=a.map(e=>e.cadence).filter(e=>e>0).map(e=>Math.max(0,Math.min(200,e)));if(e.length>0){l.fillStyle="#ffffff",l.font="bold 24px Arial, sans-serif",l.textAlign="left",l.fillText("Cadence Statistics",50,d),d+=40;let t=Math.max(...e),n=Math.min(...e),a=Math.round(e.reduce((e,t)=>e+t,0)/e.length);l.font="16px Arial, sans-serif",l.fillStyle="#cccccc",l.fillText("Average:",70,d),l.fillStyle="#f39c12",l.fillText(`${a} RPM`,200,d),d+=25,l.fillStyle="#cccccc",l.fillText("Maximum:",70,d),l.fillStyle="#f39c12",l.fillText(`${t} RPM`,200,d),d+=25,l.fillStyle="#cccccc",l.fillText("Minimum:",70,d),l.fillStyle="#f39c12",l.fillText(`${n} RPM`,200,d),d+=40}}return o.length>0||n.length>0||a.length>0?(o.length>0&&(d+=20,l.fillStyle="#ffffff",l.font="bold 20px Arial, sans-serif",l.fillText("Power Timeline",50,d),X(l,o,"power",50,d+=30,1100,300,"#3498db","W"),d+=350),n.length>0&&(l.fillStyle="#ffffff",l.font="bold 20px Arial, sans-serif",l.fillText("Heart Rate Timeline",50,d),X(l,n,"heartRate",50,d+=30,1100,300,"#e74c3c","BPM"),d+=350),a.length>0&&(l.fillStyle="#ffffff",l.font="bold 20px Arial, sans-serif",l.fillText("Cadence Timeline",50,d),X(l,a,"cadence",50,d+=30,1100,300,"#f39c12","RPM"),d+=350),r):(l.fillStyle="#cccccc",l.font="24px Arial, sans-serif",l.textAlign="center",l.fillText("No data recorded yet",600,i/2),l.font="16px Arial, sans-serif",l.fillText("Start recording to see your activity summary",600,i/2+40),r)}function X(e,t,n,a,o,r,l,s,i){if(0===t.length)return;e.fillStyle="rgba(255, 255, 255, 0.05)",e.fillRect(a,o,r,l),e.strokeStyle="rgba(255, 255, 255, 0.2)",e.lineWidth=1,e.strokeRect(a,o,r,l);let c=t.map(e=>e[n]).filter(e=>e>0);if(0===c.length)return;let d=Math.min(...c),m=Math.max(...c),u=m-d||1;e.fillStyle="#cccccc",e.font="12px Arial, sans-serif",e.textAlign="right";for(let t=0;t<=4;t++){let n=Math.round(d+u*t/4),r=o+l-l*t/4;e.fillText(n+i,a-10,r+4)}e.strokeStyle=s,e.lineWidth=2,e.beginPath();let g=!0;for(let s=0;s<t.length;s++){let i=t[s][n];if(i>0){let n=a+s/(t.length-1)*r,c=o+l-(i-d)/u*l;g?(e.moveTo(n,c),g=!1):e.lineTo(n,c)}}e.stroke(),e.fillStyle=s;for(let s=0;s<t.length;s+=Math.max(1,Math.floor(t.length/50))){let i=t[s][n];if(i>0){let n=a+s/(t.length-1)*r,c=o+l-(i-d)/u*l;e.beginPath(),e.arc(n,c,3,0,2*Math.PI),e.fill()}}e.strokeStyle="rgba(255, 255, 255, 0.1)",e.lineWidth=1;for(let t=1;t<4;t++){let n=o+l*t/4;e.beginPath(),e.moveTo(a,n),e.lineTo(a+r,n),e.stroke()}if(t.length>1){e.fillStyle="#cccccc",e.font="12px Arial, sans-serif",e.textAlign="center";let n=new Date(t[0].timestamp),s=new Date(t[t.length-1].timestamp);if(e.fillText(n.toLocaleTimeString(),a,o+l+20),e.fillText(s.toLocaleTimeString(),a+r,o+l+20),t.length>10){let n=new Date(t[Math.floor(t.length/2)].timestamp);e.fillText(n.toLocaleTimeString(),a+r/2,o+l+20)}}e.fillStyle="#ffffff",e.font="12px Arial, sans-serif",e.textAlign="left",e.fillText(`Max: ${m}${i}`,a+10,o+20),e.fillText(`Min: ${d}${i}`,a+10,o+35),e.fillText(`Avg: ${Math.round(c.reduce((e,t)=>e+t,0)/c.length)}${i}`,a+10,o+50)}async function $(e){try{if(0===e.dataPoints.length)throw Error("No data available to export. Please record some activity first.");let t=await K({dataPoints:e.dataPoints,powerAverages:e.powerAverages});return new Promise((e,n)=>{t.toBlob(t=>{t?(_(t,`power_meter_summary_${T()}.png`),e()):n(Error("Failed to generate image blob"))},"image/png")})}catch(e){throw console.error("Error generating summary image:",e),e}}function _(e,t){try{if(!e||!(e instanceof Blob))throw Error("Invalid blob provided for download");if(!t||"string"!=typeof t)throw Error("Invalid filename provided for download");let n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}catch(e){throw console.error("Error during file download:",e),e}}function ee(e,t){let n=document.createElement("div");return n.className="export-modal",n.innerHTML=`
        <div class="export-modal-content">
            <div class="export-modal-header">
                <h3 class="export-modal-title">${e}</h3>
                <button class="export-modal-close" aria-label="Close modal">&times;</button>
            </div>
            <div class="export-modal-description">${t}</div>
            <div class="export-modal-buttons"></div>
        </div>
    `,n.querySelector(".export-modal-close").addEventListener("click",()=>ea(n)),n.addEventListener("click",e=>{e.target===n&&ea(n)}),n}function et(e,t){let n=e.querySelector(".export-modal-buttons");t.forEach(e=>{let t=document.createElement("button");t.className=`export-modal-button ${e.className||""}`,t.disabled=e.disabled||!1,t.innerHTML=`
            <span>${e.text}</span>
            ${e.description?`<small style="opacity: 0.7; font-size: 0.8em;">${e.description}</small>`:""}
        `,t.addEventListener("click",e.onClick),n.appendChild(t)})}function en(e){document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("show")})}function ea(e){e.classList.remove("show"),setTimeout(()=>{e.parentNode&&document.body.removeChild(e)},300)}function eo(){let e=document.querySelector(".dashboard");if(!e)return;let t=document.querySelector(".collapsed-sections-row");t&&(t.querySelectorAll(".power-averages-section").forEach(t=>{e.parentNode.insertBefore(t,e.nextSibling)}),t.remove()),e.classList.remove("has-collapsed-sections")}let er=[],el=[],es=[],ei=[],ec=0,ed=0,em=0,eu=null,eg=null;const ep={get powerData(){return er},get rawPowerMeasurements(){return el},get heartData(){return es},get cadenceData(){return ei},get lastPowerValue(){return ec},get lastHeartRateValue(){return ed},get lastCadenceValue(){return em},get sessionStartTime(){return eu},getPowerAverages:function(){return{...x}},getPowerReadings:function(){return[...S]},resetAllSessionData:function(){er.length=0,es.length=0,ei.length=0,el.length=0,I(),ec=0,ed=0,em=0,eu=null,M(),E()},elements:B},eA={onPowerMeasurement:(e,t)=>{D(e),ec=e,el.push(t);let n=Date.now();S.push({timestamp:n,power:e});let a=n-36e4;S=S.filter(e=>e.timestamp>a),function(){let e=Date.now();for(let[t,n]of Object.entries({"10s":1e4,"20s":2e4,"30s":3e4,"40s":4e4,"50s":5e4,"1m":6e4,"2m":12e4,"3m":18e4,"4m":24e4,"5m":3e5})){let a=e-n,o=S.filter(e=>e.timestamp>=a);if(o.length>0){let e=Math.round(o.reduce((e,t)=>e+t.power,0)/o.length);x[t].current=e,e>x[t].best&&(x[t].best=e)}else x[t].current=0}}(),b()},onDisconnected:()=>{M(),I(),eg&&(clearInterval(eg),eg=null),ec=0,ey()},onStatusUpdate:e=>{B.statusText&&(B.statusText.textContent=e)}},ef={onHeartRateChange:e=>{B.hrValueElement&&(B.hrValueElement.textContent=e),ed=e},onStatusUpdate:e=>{B.hrStatusText&&(B.hrStatusText.textContent=e)},onDisconnected:()=>{ey()}},eh={onCadenceChange:e=>{B.cadenceValueElement&&(B.cadenceValueElement.textContent=e),em=e},onStatusUpdate:e=>{B.cadenceStatusText&&(B.cadenceStatusText.textContent=e)},onDisconnected:()=>{ey()}};function ey(){var e;e={powerMeter:P&&P.gatt.connected,heartRate:N&&N.gatt.connected,speedCadence:V&&V.gatt.connected},B.powerMeterConnectButton&&(B.powerMeterConnectButton.style.display=e.powerMeter?"none":"block"),B.hrConnectButton&&(B.hrConnectButton.style.display=e.heartRate?"none":"block"),B.speedCadenceConnectButton&&(B.speedCadenceConnectButton.style.display=e.speedCadence?"none":"block")}async function ew(){B.powerValueElement=document.getElementById("power-value"),B.hrValueElement=document.getElementById("hr-value"),B.cadenceValueElement=document.getElementById("cadence-value"),B.deviceNameElement=document.getElementById("device-name"),B.hrDeviceName=document.getElementById("hrDeviceName"),B.cadenceDeviceName=document.getElementById("cadenceDeviceName"),B.statusText=document.getElementById("status"),B.hrStatusText=document.getElementById("hrStatus"),B.cadenceStatusText=document.getElementById("cadenceStatus"),B.hrConnectionStatus=document.getElementById("hrConnectionStatus"),B.cadenceConnectionStatus=document.getElementById("cadenceConnectionStatus"),B.powerMeterConnectButton=document.getElementById("connectButton"),B.hrConnectButton=document.getElementById("hrConnectButton"),B.speedCadenceConnectButton=document.getElementById("speedCadenceConnectButton"),B.powerAveragesSection=document.getElementById("powerAveragesSection"),B.hamburgerBtn=document.getElementById("hamburgerButton"),B.menuDropdown=document.getElementById("menuDropdown"),B.powerAveragesToggle=document.getElementById("powerAveragesToggle"),B.powerMetricToggle=document.getElementById("powerMetricToggle"),B.heartRateMetricToggle=document.getElementById("heartRateMetricToggle"),B.cadenceMetricToggle=document.getElementById("cadenceMetricToggle"),B.showInfoMenuItem=document.getElementById("showInfoMenuItem"),B.spyModeToggle=document.getElementById("spyModeToggle"),B.powerCard=document.querySelector(".power-card"),B.heartRateCard=document.querySelector(".hr-card"),B.cadenceCard=document.querySelector(".cadence-card"),B.spyCard=document.querySelector(".spy-card"),B.spyModeSection=document.getElementById("spyModeSection"),B.spyValueElement=document.getElementById("spy-value"),B.spyStatusElement=document.getElementById("spyStatus"),B.spyInstructionsElement=document.getElementById("spyInstructions"),B.hrConnectionStatus&&(B.hrConnectionStatus.textContent="Disconnected"),B.cadenceConnectionStatus&&(B.cadenceConnectionStatus.textContent="Disconnected"),e=document.getElementById("avg10s-current"),t=document.getElementById("avg10s-best"),n=document.getElementById("avg20s-current"),a=document.getElementById("avg20s-best"),o=document.getElementById("avg30s-current"),r=document.getElementById("avg30s-best"),l=document.getElementById("avg40s-current"),s=document.getElementById("avg40s-best"),i=document.getElementById("avg50s-current"),c=document.getElementById("avg50s-best"),d=document.getElementById("avg1m-current"),m=document.getElementById("avg1m-best"),u=document.getElementById("avg2m-current"),g=document.getElementById("avg2m-best"),p=document.getElementById("avg3m-current"),A=document.getElementById("avg3m-best"),f=document.getElementById("avg4m-current"),h=document.getElementById("avg4m-best"),y=document.getElementById("avg5m-current"),w=document.getElementById("avg5m-best"),B.powerAveragesSection&&(B.powerAveragesSection.style.display="block");let M=document.querySelector(".dashboard"),k=document.getElementById("powerAveragesSection"),L=k&&"none"===k.style.display;M&&(L?M.classList.add("maximized"):M.classList.remove("maximized")),eo(),function(e){if(!e.hamburgerBtn||!e.menuDropdown)return console.error("Hamburger menu elements not found:",{hamburgerBtn:!!e.hamburgerBtn,menuDropdown:!!e.menuDropdown});e.hamburgerBtn.addEventListener("click",function(){e.menuDropdown.classList.contains("active")?e.menuDropdown.classList.remove("active"):e.menuDropdown.classList.add("active")}),document.addEventListener("click",function(t){t.target.closest(".hamburger-menu")||e.menuDropdown.classList.remove("active")})}(B),function(e){if(!e.powerAveragesToggle||!e.powerAveragesSection)return console.error("Power averages toggle elements not found:",{powerAveragesToggle:!!e.powerAveragesToggle,powerAveragesSection:!!e.powerAveragesSection});let t=!0;e.powerAveragesToggle.classList.add("active"),e.powerAveragesToggle.addEventListener("click",function(){(t=!t)?(e.powerAveragesSection.style.display="block",e.powerAveragesToggle.classList.add("active")):(e.powerAveragesSection.style.display="none",e.powerAveragesToggle.classList.remove("active")),eo()})}(B);if(B.powerMetricToggle&&B.powerCard){let e=!0;B.powerMetricToggle.classList.add("active"),B.powerMetricToggle.addEventListener("click",function(){(e=!e)?(B.powerCard.style.display="block",B.powerMetricToggle.classList.add("active")):(B.powerCard.style.display="none",B.powerMetricToggle.classList.remove("active"))})}else console.error("Power metric toggle elements not found");if(B.heartRateMetricToggle&&B.heartRateCard){let e=!0;B.heartRateMetricToggle.classList.add("active"),B.heartRateMetricToggle.addEventListener("click",function(){(e=!e)?(B.heartRateCard.style.display="block",B.heartRateMetricToggle.classList.add("active")):(B.heartRateCard.style.display="none",B.heartRateMetricToggle.classList.remove("active"))})}else console.error("Heart rate metric toggle elements not found");if(B.cadenceMetricToggle&&B.cadenceCard){let e=!0;B.cadenceMetricToggle.classList.add("active"),B.cadenceMetricToggle.addEventListener("click",function(){(e=!e)?(B.cadenceCard.style.display="block",B.cadenceMetricToggle.classList.add("active")):(B.cadenceCard.style.display="none",B.cadenceMetricToggle.classList.remove("active"))})}else console.error("Cadence metric toggle elements not found");!function(e,t){if(!e.spyModeToggle||!e.spyModeSection)return console.error("Spy mode toggle elements not found");let n=!1;e.spyModeToggle.addEventListener("click",function(){(n=!n)?(e.spyModeSection.style.display="block",e.spyModeToggle.classList.add("active")):(e.spyModeSection.style.display="none",e.spyModeToggle.classList.remove("active"),t(),e.spyValueElement&&(e.spyValueElement.textContent="--"),e.spyStatusElement&&(e.spyStatusElement.style.display="none")),e.spyInstructionsElement&&(e.spyInstructionsElement.style.display="block")})}(B,()=>H(B)),B.showInfoMenuItem?B.showInfoMenuItem.addEventListener("click",function(){!function(){let e=document.createElement("div");e.className="modal-backdrop",e.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;let t=document.createElement("div");t.className="modal",t.style.cssText=`
        background: #1a1a2e;
        border-radius: 12px;
        padding: 2rem;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        margin: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    `;let n=document.createElement("canvas");n.width=200,n.height=200,n.style.cssText=`
        background: white;
        border-radius: 8px;
        margin: 1rem auto;
        max-width: 100%;
        height: auto;
        display: block;
    `,t.innerHTML=`
        <div style="text-align: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0 0 0.5rem 0; font-size: 1.8rem;">\u{1F6B4} Web Bluetooth Power Meter</h2>
            <p style="color: #cccccc; margin: 0; font-size: 1rem;">Real-time cycling data analysis</p>
        </div>

        <div style="color: #ffffff; line-height: 1.6;">
            <h3 style="color: #f39c12; margin: 1.5rem 0 1rem 0;">\u{1F4F1} Share This App</h3>
            <div style="text-align: center; margin-bottom: 1rem;">
                <div id="qr-container" style="margin: 1rem 0;"></div>
                <p style="color: #ffffff; margin: 0.5rem 0; font-weight: 600;">Scan to access on any device</p>
                <a href="https://colscoding.github.io/power-saver/" target="_blank" style="
                    color: #9b59b6; 
                    text-decoration: none; 
                    font-size: 0.9rem;
                    word-break: break-all;
                    line-height: 1.4;
                ">https://colscoding.github.io/power-saver/</a>
            </div>

            <h3 style="color: #f39c12; margin: 1.5rem 0 1rem 0;">\u{1F4F1} What is this app?</h3>
            <p style="margin-bottom: 1rem;">
                This is a web-based power meter application that connects to Bluetooth devices:
            </p>
            <ul style="margin: 0 0 1rem 1rem; padding-left: 1rem;">
                <li>cycling power meter</li>
                <li>cadence sensor</li>
                <li>heart rate sensor</li>
            </ul>
        </div>

        <div style="text-align: center; margin-top: 2rem;">
            <button id="closeInfoModal" style="
                background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            ">Got it!</button>
        </div>
    `,t.querySelector("#qr-container").appendChild(n),function(e){let t=e.getContext("2d"),n=e.width;t.fillStyle="#ffffff",t.fillRect(0,0,n,n);let a=new Image;a.onload=function(){t.drawImage(a,0,0,n,n)},a.onerror=function(){var e=t,a=n;e.fillStyle="#000000",e.font="12px Arial",e.textAlign="center";let o=a/25;for(let t=0;t<25;t++)for(let n=0;n<25;n++)((t+n)%3==0||0===t||24===t||0===n||24===n)&&e.fillRect(t*o,n*o,o,o);e.fillStyle="#ffffff",e.fillRect(.2*a,.4*a,.6*a,.2*a),e.fillStyle="#000000",e.fillText("QR Code",a/2,a/2-10),e.fillText("Unavailable",a/2,a/2+10)},a.src="data:image/png;base64,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"}(n),e.appendChild(t),document.body.appendChild(e);let a=t.querySelector("#closeInfoModal"),o=()=>{document.body.removeChild(e)};a.addEventListener("click",o),e.addEventListener("click",t=>{t.target===e&&o()});let r=e=>{"Escape"===e.key&&(o(),document.removeEventListener("keydown",r))};document.addEventListener("keydown",r),a.addEventListener("mouseenter",()=>{a.style.transform="translateY(-2px)",a.style.boxShadow="0 8px 24px rgba(52, 152, 219, 0.4)"}),a.addEventListener("mouseleave",()=>{a.style.transform="translateY(0)",a.style.boxShadow="none"})}(),B.menuDropdown&&B.menuDropdown.classList.remove("active")}):console.error("Show info menu item not found"),B.powerMeterConnectButton&&B.powerMeterConnectButton.addEventListener("click",async()=>{er.length=0,el.length=0,ec=0,I(),eg&&clearInterval(eg),await O(eA,B)&&(eu||(eu=Date.now()),eg=setInterval(()=>{er.push({timestamp:Date.now(),power:ec,heartRate:ed,cadence:em}),er.length%100==0&&C(ep)},100),ey())}),B.hrConnectButton&&B.hrConnectButton.addEventListener("click",async()=>{await W(ef,B)&&ey()}),B.speedCadenceConnectButton&&B.speedCadenceConnectButton.addEventListener("click",async()=>{await j(eh,B)&&ey()}),B.spyCard&&B.spyCard.addEventListener("click",async()=>{U&&U.gatt.connected?H(B):await q({},B)});let Q=document.getElementById("exportMenuItem");Q&&Q.addEventListener("click",()=>{let e=ee("\uD83D\uDCC4 Basic Exports","Export your session data in various formats"),t=[{text:"\uD83D\uDCCB Export Summary JSON",description:"Session summary with averages",onClick:()=>{var t=ep.powerData;if(!t||!Array.isArray(t)||0===t.length)throw Error("No valid power data available to export as JSON");_(new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),`power_data_${T()}.json`),ea(e)}},{text:"\uD83D\uDCCA Export Summary CSV",description:"Session summary for spreadsheets",onClick:()=>{var t=ep.powerData;if(!t||!Array.isArray(t)||0===t.length)throw Error("No valid power data available to export as CSV");let n="timestamp,power,heartRate,cadence\n";t.forEach(e=>{let t=e.timestamp||"",a=e.power||"",o=e.heartRate||"",r=e.cadence||"";n+=`${t},${a},${o},${r}
`}),_(new Blob([n],{type:"text/csv;charset=utf-8;"}),`power_data_${T()}.csv`),ea(e)}},{text:"\uD83C\uDFC3 Export TCX",description:"Training Center XML format",onClick:()=>{try{var t=ep.powerData;try{if(0===t.length)throw Error("No power data available to export.");let e=function(e){if(!Array.isArray(e)||0===e.length)return"";let t=e.filter(e=>e&&"object"==typeof e&&void 0!==e.timestamp&&!isNaN(new Date(e.timestamp).getTime()));if(0===t.length)return"";let n=t.map(e=>({time:e.timestamp,...void 0!==e.power&&{power:e.power},...void 0!==e.heartRate&&{heartRate:e.heartRate},...void 0!==e.cadence&&{cadence:e.cadence}})).sort((e,t)=>e.time-t.time),a=e=>!e.power||e.power<=0;for(;n.length>0&&a(n[0]);)n.shift();for(;n.length>0&&a(n[n.length-1]);)n.pop();if(0===n.length)return"";let o=n.map(G).join("\n"),r=new Date(n[0].time).toISOString();return`<?xml version="1.0" encoding="UTF-8"?>
<TrainingCenterDatabase
  xmlns="http://www.garmin.com/xmlschemas/TrainingCenterDatabase/v2"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.garmin.com/xmlschemas/TrainingCenterDatabase/v2 http://www.garmin.com/xmlschemas/TrainingCenterDatabasev2.xsd"
  xmlns:ns2="http://www.garmin.com/xmlschemas/ActivityExtension/v2">
  <Activities>
    <Activity Sport="Biking">
      <Id>${r}</Id>
      <Name>E Bike Indoor Cycling Trainer</Name>
      <Lap StartTime="${r}">
        <Track>
        ${o}
        </Track>
      </Lap>
    </Activity>
  </Activities>
</TrainingCenterDatabase>`}(t),n=new Blob([e],{type:"application/xml;charset=utf-8;"});_(n,`power_data_${T()}.tcx`)}catch(e){throw console.error("Error generating TCX:",e),e}ea(e)}catch(e){alert(`Error generating TCX file: ${e.message}`)}}},{text:"\uD83D\uDD0D Export Raw JSON",description:"Complete measurement data",onClick:()=>{_(new Blob([JSON.stringify(ep.rawPowerMeasurements,null,2)],{type:"application/json"}),`raw_power_measurements_${T()}.json`),ea(e)}},{text:"\uD83D\uDCC8 Export Raw CSV",description:"Raw measurements for analysis",onClick:()=>{var t;let n;t=ep.rawPowerMeasurements,n="timestamp,flags,dataLength,instantaneousPower,rawBytes\n",t.forEach(e=>{n+=`${e.timestamp},${e.flags},${e.dataLength},${e.instantaneousPower},"${e.rawBytes}"
`}),_(new Blob([n],{type:"text/csv;charset=utf-8;"}),`raw_power_measurements_${T()}.csv`),ea(e)}},{text:"\uD83D\uDDBC️ Export Summary Image",description:"Visual summary of your session",className:"primary",onClick:async()=>{try{await $({dataPoints:ep.powerData,powerAverages:ep.getPowerAverages()}),ea(e)}catch(e){alert(`Error generating summary image: ${e.message}`)}}}];et(e,t),en(e)});let R=document.getElementById("exportUtilsMenuItem");R&&R.addEventListener("click",()=>{let e=ee("\uD83D\uDEE0️ Utilities","Session management and utilities"),t=[{text:"\uD83D\uDDD1️ Clear Session Data",description:"Clear all session data (cannot be undone)",className:"danger",onClick:()=>{confirm("Are you sure you want to clear all session data? This action cannot be undone.")&&(ep.resetAllSessionData(),alert("Session data cleared successfully!"),ea(e))}}];et(e,t),en(e)}),ey();let P=function(){try{let e=localStorage.getItem(v);if(!e)return null;let t=JSON.parse(e);if(Date.now()-t.timestamp>864e5)return localStorage.removeItem(v),null;return t}catch(e){return console.warn("Failed to load session data:",e),localStorage.removeItem(v),null}}();P&&await new Promise(e=>{let t=document.createElement("div");t.className="modal-backdrop";let n=document.createElement("div");n.className="modal";let a=Math.round((Date.now()-P.timestamp)/6e4),o=(P.powerData?.length||0)+(P.heartData?.length||0)+(P.cadenceData?.length||0);n.innerHTML=`
      <h3>Previous Session Found</h3>
      <p>
        A previous session was found from ${a} minutes ago with ${o} data points.
      </p>
      <p>
        Would you like to restore this session or start fresh?
      </p>
      <div class="modal-buttons">
        <button id="startFresh" class="modal-button secondary">Start Fresh</button>
        <button id="restoreSession" class="modal-button primary">Restore Session</button>
      </div>
    `,t.appendChild(n),document.body.appendChild(t),n.querySelector("#startFresh").addEventListener("click",()=>{document.body.removeChild(t),E(),e(!1)}),n.querySelector("#restoreSession").addEventListener("click",()=>{document.body.removeChild(t),e(!0)}),t.addEventListener("click",n=>{n.target===t&&(document.body.removeChild(t),e(!1))})})?function(e){try{var t,n;e.powerData&&(er.length=0,er.push(...e.powerData)),e.heartData&&(es.length=0,es.push(...e.heartData)),e.cadenceData&&(ei.length=0,ei.push(...e.cadenceData)),e.rawPowerMeasurements&&(el.length=0,el.push(...e.rawPowerMeasurements)),e.powerReadings&&(S=[...e.powerReadings]),e.powerAverages&&(t=e.powerAverages,Object.assign(x,t),b()),void 0!==e.lastPowerValue&&(ec=e.lastPowerValue),void 0!==e.lastHeartRateValue&&(ed=e.lastHeartRateValue),void 0!==e.lastCadenceValue&&(em=e.lastCadenceValue),void 0!==e.sessionStartTime&&(eu=e.sessionStartTime),void 0!==(n={power:ec,heartRate:ed,cadence:em}).power&&D(n.power),void 0!==n.heartRate&&B.hrValueElement&&(B.hrValueElement.textContent=n.heartRate||"--"),void 0!==n.cadence&&B.cadenceValueElement&&(B.cadenceValueElement.textContent=n.cadence||"--"),b(),er.length>0&&function(e){let t=document.createElement("div");t.style.cssText=`
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    z-index: 1000;
    font-size: 0.9rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: slideIn 0.3s ease-out;
  `,t.textContent=`Session restored! ${e} data points recovered.`;let n=document.createElement("style");n.textContent=`
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  `,document.head.appendChild(n),document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideIn 0.3s ease-out reverse",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),n.parentNode&&n.parentNode.removeChild(n)},300)},5e3)}(er.length)}catch(e){return console.warn("Failed to restore session data:",e),!1}}(P):eu=Date.now(),window.addEventListener("beforeunload",function(){er.length>0&&C(ep)}),setInterval(()=>{er.length>0&&C(ep)},3e4)}document.addEventListener("DOMContentLoaded",ew);
//# sourceMappingURL=power-saver.4ac11674.js.map

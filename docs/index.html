<!DOCTYPE html><html lang=en><meta charset=UTF-8><meta name=viewport content="width=device-width, initial-scale=1.0"><title>Web Bluetooth Power Meter</title><style>body{color:#fff;background-color:#121212;flex-direction:column;justify-content:center;align-items:center;height:100vh;margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;display:flex}.container{text-align:center;background:#1e1e1e;border-radius:16px;min-width:320px;padding:2rem 3rem;box-shadow:0 8px 24px #00000080}h1{color:#f39c12;margin-bottom:1rem;font-size:1.8rem}button{color:#121212;cursor:pointer;background-color:#f39c12;border:none;border-radius:8px;padding:14px 28px;font-size:16px;font-weight:700;transition:all .3s}button:hover{background-color:#e67e22;transform:translateY(-2px);box-shadow:0 4px 10px #f39c124d}button:disabled{color:#888;cursor:not-allowed;box-shadow:none;background-color:#555;transform:translateY(0)}.power-display{margin:2rem 0;padding:1rem}.power-display span{color:#fff;font-size:7rem;font-weight:700;line-height:1}.power-display small{color:#aaa;margin-left:8px;font-size:1.5rem}#status{color:#bbb;height:20px;margin-top:1rem;font-style:italic}#device-name{color:#f39c12;margin-top:8px;font-weight:700}.hr-display{margin:2rem 0}.hr-display span{color:#d32f2f;font-size:6rem;font-weight:700}.hr-display small{color:#5f6368;font-size:1.5rem}.cadence-display{margin:2rem 0}.cadence-display span{color:#2980b9;font-size:6rem;font-weight:700}.cadence-display small{color:#5f6368;font-size:1.5rem}.speed-display{margin:2rem 0}.speed-display span{color:#27ae60;font-size:6rem;font-weight:700}.speed-display small{color:#5f6368;font-size:1.5rem}.distance-display{margin:1rem 0}.distance-display span{color:#27ae60;font-size:3rem;font-weight:700}.distance-display small{color:#5f6368;font-size:1.5rem}.advanced-metrics{justify-content:space-around;width:100%;margin:1rem 0;display:flex}.metric-box{flex-direction:column;align-items:center;display:flex}.metric-box span{font-size:2.5rem;font-weight:700}.metric-box small{color:#aaa;font-size:.9rem}#hrStatus{color:#5f6368;height:20px;margin-top:1rem}#hrDeviceName{color:#333;font-weight:700}</style><body>

    <div class=container>
        <h1>Cycling Data üö¥‚ù§Ô∏è</h1>
        <div class=power-display>
            <span id=power-value>--</span>
            <small>Watts</small>
        </div>
        <div class=advanced-metrics>
            <div class=metric-box>
                <span id=balance-value>--</span>
                <small>L/R Balance</small>
            </div>
            <div class=metric-box>
                <span id=smoothness-value>--</span>
                <small>Pedal Smoothness</small>
            </div>
            <div class=metric-box>
                <span id=torque-value>--</span>
                <small>Torque Effect.</small>
            </div>
        </div>
        <div class=hr-display>
            <span id=hr-value>--</span>
            <small>BPM</small>
        </div>
        <div class=cadence-display>
            <span id=cadence-value>--</span>
            <small>RPM</small>
        </div>
        <div class=speed-display>
            <span id=speed-value>--</span>
            <small>km/h</small>
        </div>
        <div class=distance-display>
            <span id=distance-value>--</span>
            <small>km</small>
        </div>
        <p id=status>Disconnected</p>
        <p id=device-name></p>
        <p id=hrStatus style=display:none></p>
        <p id=hrDeviceName style=display:none></p>
        <p id=cadenceStatus style=display:none></p>
        <p id=cadenceDeviceName style=display:none></p>
    </div>

    <div class=container>
        <button id=connectButton>Connect to Power Meter</button>
        <button id=hrConnectButton>Connect to Heart Rate Monitor</button>
        <button id=speedCadenceConnectButton>Connect to Speed &amp; Cadence</button>
        <div id=export-buttons style=margin-top:1rem;display:none>
            <button id=exportJsonButton>Export JSON</button>
            <button id=exportCsvButton>Export CSV</button>
        </div>
    </div>

    <script>let wakeLock=null;async function requestWakeLock(){if("wakeLock"in navigator)try{wakeLock=await navigator.wakeLock.request("screen"),console.log("Screen Wake Lock is active."),wakeLock.addEventListener("release",()=>{console.log("Screen Wake Lock was released.")})}catch(e){console.error(`${e.name}, ${e.message}`)}}async function releaseWakeLock(){null!==wakeLock&&(await wakeLock.release(),wakeLock=null)}let connectButton=document.getElementById("connectButton"),statusText=document.getElementById("status"),powerValueElement=document.getElementById("power-value"),deviceNameElement=document.getElementById("device-name"),exportButtons=document.getElementById("export-buttons"),exportJsonButton=document.getElementById("exportJsonButton"),exportCsvButton=document.getElementById("exportCsvButton");exportButtons.style.display="block";let balanceValueElement=document.getElementById("balance-value"),smoothnessValueElement=document.getElementById("smoothness-value"),torqueValueElement=document.getElementById("torque-value"),lastPowerValue=0,lastHeartRateValue=0,lastCadenceValue=0,lastSpeedValue=0,lastBalanceValue=0,lastSmoothnessValue=0,lastTorqueValue=0,totalDistance=0,dataLoggerInterval=null,powerMeterDevice=null,CYCLING_POWER_SERVICE_UUID="cycling_power",CYCLING_POWER_MEASUREMENT_CHARACTERISTIC_UUID="cycling_power_measurement",CYCLING_POWER_FEATURE_CHARACTERISTIC_UUID="cycling_power_feature",CYCLING_CADENCE_SERVICE_UUID="cycling_speed_and_cadence",CSC_MEASUREMENT_CHARACTERISTIC_UUID="csc_measurement";function handlePowerMeasurement(e){let t=e.target.value,n=t.getUint16(0,!0),a=2,o=t.getInt16(a,!0);if(powerValueElement.textContent=o,lastPowerValue=o,a+=2,balanceValueElement.textContent="--",lastBalanceValue=0,smoothnessValueElement.textContent="--",lastSmoothnessValue=0,torqueValueElement.textContent="--",lastTorqueValue=0,1&n){let e=t.getUint8(a);balanceValueElement.textContent=`${100-e}/${e}`,lastBalanceValue=e,a+=1}if(4&n&&(a+=2),16&n&&(a+=6),32&n&&(a+=4),128&n&&(a+=6),512&n&&(a+=4),2048&n&&(a+=2),4096&n){let e=t.getUint8(a)/2,n=t.getUint8(a+2)/2;torqueValueElement.textContent=e.toFixed(1),smoothnessValueElement.textContent=n.toFixed(1),lastTorqueValue=e,lastSmoothnessValue=n,a+=4}}function parsePowerMeasurement(e){return e.getInt16(2,!0)}function onDisconnected(){statusText.textContent="Device disconnected.",deviceNameElement.textContent="",powerValueElement.textContent="--",balanceValueElement.textContent="--",smoothnessValueElement.textContent="--",torqueValueElement.textContent="--",connectButton.disabled=!1,dataLoggerInterval&&(clearInterval(dataLoggerInterval),dataLoggerInterval=null),powerMeterDevice&&(powerMeterDevice.removeEventListener("gattserverdisconnected",onDisconnected),powerMeterDevice=null),lastPowerValue=0,lastBalanceValue=0,lastSmoothnessValue=0,lastTorqueValue=0}connectButton.addEventListener("click",async()=>{if(await requestWakeLock(),!navigator.bluetooth){statusText.textContent="Web Bluetooth API is not available.";return}powerData=[],lastPowerValue=0,dataLoggerInterval&&clearInterval(dataLoggerInterval);try{statusText.textContent="Scanning for power meters...",powerMeterDevice=await navigator.bluetooth.requestDevice({filters:[{services:[CYCLING_POWER_SERVICE_UUID]}]}),statusText.textContent="Connecting to device...",deviceNameElement.textContent=`Device: ${powerMeterDevice.name||"Unknown Device"}`,powerMeterDevice.addEventListener("gattserverdisconnected",onDisconnected);let e=await powerMeterDevice.gatt.connect(),t=await e.getPrimaryService(CYCLING_POWER_SERVICE_UUID),n=await t.getCharacteristic("cycling_power_measurement");try{let e=await t.getCharacteristic("cycling_power_feature"),n=await e.readValue();console.log(`Power Features: ${n.getUint32(0,!0)}`)}catch(e){console.log("Cycling Power Feature characteristic not found.")}await n.startNotifications(),n.addEventListener("characteristicvaluechanged",handlePowerMeasurement),statusText.textContent="Connected and receiving data!",connectButton.disabled=!0,dataLoggerInterval=setInterval(()=>{powerData.push({timestamp:Date.now(),power:lastPowerValue,heartRate:lastHeartRateValue,cadence:lastCadenceValue,speed:lastSpeedValue,distance:totalDistance,balance:lastBalanceValue,smoothness:lastSmoothnessValue,torque:lastTorqueValue})},100)}catch(e){statusText.textContent=`Error: ${e.message}`,console.error("Connection failed:",e),powerMeterDevice&&powerMeterDevice.removeEventListener("gattserverdisconnected",onDisconnected)}}),exportJsonButton.addEventListener("click",()=>{let e=new Blob([JSON.stringify(powerData,null,2)],{type:"application/json"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t;let a=new Date,o=a.getFullYear(),c=String(a.getMonth()+1).padStart(2,"0"),l=String(a.getDate()).padStart(2,"0"),r=`${o}-${c}-${l}`;n.download=`power_data_${r}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)}),exportCsvButton.addEventListener("click",()=>{let e="timestamp,power,heartRate,cadence,speed,distance,balance,smoothness,torque\n";powerData.forEach(t=>{e+=`${t.timestamp},${t.power},${t.heartRate},${t.cadence},${t.speed},${t.distance},${t.balance||""},${t.smoothness||""},${t.torque||""}
`});let t=new Blob([e],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n;let o=new Date,c=o.getFullYear(),l=String(o.getMonth()+1).padStart(2,"0"),r=String(o.getDate()).padStart(2,"0"),s=`${c}-${l}-${r}`;a.download=`power_data_${s}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)});let heartData=[],hrDataLoggerInterval=null,hrConnectButton=document.getElementById("hrConnectButton"),hrStatusText=document.getElementById("hrStatus"),hrValue=document.getElementById("hr-value"),hrDeviceName=document.getElementById("hrDeviceName"),hrBluetoothDevice=null;function handleHeartRateChanged(e){let t=parseHeartRate(e.target.value);hrValue.textContent=t,lastHeartRateValue=t}function parseHeartRate(e){return 1&e.getUint8(0)?e.getUint16(1,!0):e.getUint8(1)}function onDisconnectedHr(){hrStatusText.textContent="Device disconnected.",hrDeviceName.textContent="",hrValue.textContent="--",hrConnectButton.disabled=!1,hrBluetoothDevice=null,lastHeartRateValue=0}hrConnectButton.addEventListener("click",async()=>{if(await requestWakeLock(),!navigator.bluetooth){hrStatusText.textContent="Web Bluetooth API is not available.";return}try{hrStatusText.textContent="Scanning for devices...",hrBluetoothDevice=await navigator.bluetooth.requestDevice({filters:[{services:["heart_rate"]}]}),hrStatusText.textContent="Connecting to device...",hrDeviceName.textContent=`Device: ${hrBluetoothDevice.name}`,hrBluetoothDevice.addEventListener("gattserverdisconnected",onDisconnectedHr);let e=await hrBluetoothDevice.gatt.connect(),t=await e.getPrimaryService("heart_rate"),n=await t.getCharacteristic("heart_rate_measurement");await n.startNotifications(),n.addEventListener("characteristicvaluechanged",handleHeartRateChanged),hrStatusText.textContent="Connected!",hrConnectButton.disabled=!0}catch(e){hrStatusText.textContent=`Error: ${e.message}`,console.error("Connection failed:",e)}});let speedCadenceConnectButton=document.getElementById("speedCadenceConnectButton"),cadenceValueElement=document.getElementById("cadence-value"),speedValueElement=document.getElementById("speed-value"),distanceValueElement=document.getElementById("distance-value"),cadenceStatusText=document.getElementById("cadenceStatus"),cadenceDeviceName=document.getElementById("cadenceDeviceName"),speedCadenceBluetoothDevice=null,WHEEL_CIRCUMFERENCE=2.105;speedCadenceConnectButton.addEventListener("click",async()=>{if(await requestWakeLock(),!navigator.bluetooth){cadenceStatusText.textContent="Web Bluetooth API is not available.";return}try{cadenceStatusText.textContent="Scanning for sensors...",speedCadenceBluetoothDevice=await navigator.bluetooth.requestDevice({filters:[{services:[CYCLING_CADENCE_SERVICE_UUID]}]}),cadenceStatusText.textContent="Connecting to device...",cadenceDeviceName.textContent=`Device: ${speedCadenceBluetoothDevice.name}`,speedCadenceBluetoothDevice.addEventListener("gattserverdisconnected",onDisconnectedSpeedCadence);let e=await speedCadenceBluetoothDevice.gatt.connect(),t=await e.getPrimaryService(CYCLING_CADENCE_SERVICE_UUID),n=await t.getCharacteristic("csc_measurement");await n.startNotifications(),n.addEventListener("characteristicvaluechanged",handleSpeedCadenceMeasurement),cadenceStatusText.textContent="Connected!",speedCadenceConnectButton.disabled=!0}catch(e){cadenceStatusText.textContent=`Error: ${e.message}`,console.error("Speed/Cadence connection failed:",e)}});let lastWheelRevs=0,lastWheelTime=0,lastCrankRevs=0,lastCrankTime=0;function handleSpeedCadenceMeasurement(e){let t=e.target.value,n=t.getUint8(0),a=1;if(1&n){let e=t.getUint32(a,!0),n=t.getUint16(a+4,!0);if(a+=6,lastWheelRevs>0){let t=e-lastWheelRevs,a=(n-lastWheelTime)/1024;if(a>0){let e=2.105*t;totalDistance+=e/1e3;let n=e/a*3.6;speedValueElement.textContent=Math.round(n),lastSpeedValue=Math.round(n),distanceValueElement.textContent=totalDistance.toFixed(2)}}lastWheelRevs=e,lastWheelTime=n}if(2&n){let e=t.getUint16(a,!0),n=t.getUint16(a+2,!0);if(lastCrankRevs>0){let t=e-lastCrankRevs,a=(n-lastCrankTime)/1024;if(a>0){let e=t/a*60;cadenceValueElement.textContent=Math.round(e),lastCadenceValue=Math.round(e)}}lastCrankRevs=e,lastCrankTime=n}}function onDisconnectedSpeedCadence(){cadenceStatusText.textContent="Device disconnected.",cadenceDeviceName.textContent="",cadenceValueElement.textContent="--",speedValueElement.textContent="--",speedCadenceConnectButton.disabled=!1,speedCadenceBluetoothDevice=null,lastCadenceValue=0,lastSpeedValue=0}</script>



